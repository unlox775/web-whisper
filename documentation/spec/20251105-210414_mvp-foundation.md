# MVP First Draft — Iteration Log

**Prompt slug:** `mvp-foundation`  
**Last updated:** 2025-11-06 01:45 UTC

This living spec rolls up every instruction and deliverable from the ongoing MVP push. See `20251105-210414_mvp-foundation-PROMPT.txt` for the full prompt history (chronological, earliest-first).

## Prompt Timeline (high level)

- **2025-11-06T01:30Z** – Deepen chunk QA: resolve per-chunk playback errors, add developer chunk downloads and per-chunk playheads, document/init-segment artifact, guarantee final chunk persistence, add playback volume control, and align macOS icon surfaces.
- **2025-11-06T00:59Z** – Request per-chunk playback controls, fractional-second display, and investigation of consistently tiny first chunks.
- **2025-11-06T00:50Z** – Reordered prompt log chronologically, request volume controls, and called for tighter session card layout.
- **2025-11-06T00:40Z** – Add deeper chunk inspection tooling (sort chunks by start time, surface verified blob sizes) to investigate persistent 641-byte first slices.
- **2025-11-06T00:11Z** – Consolidate documentation workflow into a single spec/prompt pair; enforce prepending new prompts; fix branding still showing “frontend”/Vite icon.
- **2025-11-05T23:35Z** – Final chunk loss persists; tighten developer log layout, add fractional-second timestamps, ensure end-of-recording chunk flush, refresh branding/icon usage.
- **2025-11-05T22:55Z** – Rename install surfaces to “Web Whisper”, refresh public README with onboarding narrative, drop chunk counts from public UI, keep format info developer-only.
- **2025-11-05T22:35Z** – Add persistent settings store, developer mode, debugging overlays, richer playback controls, smart size formatting.
- **2025-11-05T22:04Z** – Restore GitHub Pages build output to `docs/` and relocate documentation into `documentation/`.
- **2025-11-05T20:57Z onward** – Original MVP charter covering durable capture, adaptive snipping, transcription pipeline, and testing strategy.

## Delivery Summary (cumulative)

### Capture & Durability Backbone — Delivered 2025-11-05
- Built `BrowserCaptureController` for continuous `MediaRecorder` capture (AAC on iOS, WebM fallback) with 4 s timeslices.
- Persist chunks + session manifests via `IndexedDBManifestService`, including recovery of dangling “recording” sessions after crashes.
- Combined persisted blobs for playback, exposed metadata queries, and surfaced storage totals in the UI.

### Settings & Developer Instrumentation — Delivered 2025-11-05
- Added `PersistentSettingsStore` (localStorage) storing Groq API key, developer-mode toggle, and storage cap.
- Introduced developer strip (live chunk counter, buffer bytes), bug toggles for chunk detail, and IndexedDB inspector overlay with table row previews.
- Reworked playback panel with play/pause toggle, progress meter, timestamps, and developer-only chunk table; size formatting now auto-selects units with four significant digits.

### Branding, Docs & Public UX — Delivered 2025-11-05 ±
- Reset GitHub Pages build path to `docs/` and moved all specifications under `documentation/`.
- Updated README with installation guide, Groq onboarding notes, current status summary, and credits to Whisper & Cursor workflow.
- Cleaned public session cards (duration-first display, retry button space) and hid chunk counts/format outside developer mode.

### Final Chunk Flush & Log Compaction — Delivered 2025-11-06
- Ensured `stop()` waits for a final `dataavailable` after `requestData()`, using either native timecodes or bounded fallback increments so sub-timeslice recordings retain audio.
- Logged chunk durations with start/end offsets and mark last-chunk timestamps in capture state for accurate state reporting.
- Tightened developer log layout (reduced padding, right-aligned level/time metadata, wrapped JSON) and added fractional-second timestamps with graceful fallback.

### Playback QA & Developer Tooling — In Progress 2025-11-06
- Triage per-chunk `NotSupportedError` failures and confirm chunk MIME handling across browsers.
- Add developer affordances: per-chunk play/pause controls, blob byte-length verification, and direct chunk download links (timestamped filenames).
- Expose playback volume slider (100% default) and tighten session card layout (duration + status on one line, metadata secondary).
- Document/init-segment artifact in chunk lists and decide whether to hide, merge, or explain the bootstrap slice.
- Verify macOS PWA metadata so the installed app shows the Web Whisper name and custom icon across tab, install prompt, and dock tile.
- Rebranded the app shell to “Web Whisper”, updated favicon/manifest titles, and confirmed icon assets (`public/pwa-192x192.svg`, `public/pwa-512x512.svg`) are referenced everywhere, ensuring install prompts drop “frontend”.

### Collaboration Guardrails — Updated 2025-11-06
- `agents.md` now leads with an all-caps directive to prepend new prompts before coding and clarifies that a single spec/prompt pair must remain authoritative for this effort.

## Active Investigations

### NotSupportedError on per-chunk playback
- Segment buttons intermittently throw `NotSupportedError: Failed to load because no supported source was found` when playing chunk 2.
- Actions: log MIME types, ensure we’re creating object URLs with accurate codecs string, and verify we’re not serving the init segment stub by mistake.

### Per-chunk loudness & playback controls
- Playback starts at a very low gain; add a visible volume slider (100% default) and ensure per-chunk preview controls honor it.
- Confirm global playback remembers volume between sessions or document default behavior.

### Developer chunk downloads
- Provide a download link in developer mode for each chunk (e.g., `2025-11-06T01-30-23_chunk-2.mp4`).
- Ensure fetched blob respects current codec/container and verify file size after download for debugging.

### Init-segment artifact
- Sequence 0 appears as a tiny “init segment” entry at 0.00 s; decide whether to hide it from UI, merge with chunk 1, or document why it exists.
- If we keep it, label it clearly so developers know it’s a bootstrap slice rather than user audio.

### Final chunk race condition
- Logs show `recorder stop requested` before the last `dataavailable`, leading to lost audio (~2 s). Root cause likely `stop()` firing before the chunker flushes.
- Proposed fix: have the chunking workflow request the final slice, await resolution, then stop media tracks; add explicit state to guarantee a final persist.
- Update spec + code comments once resolved so future contributors understand the handshake.

### macOS title & icon alignment
- Dock icon still shows the default Vite badge; window title reads “Frontend.”
- Actions: audit manifest, `apple-touch-icon`, `chrome://flags/#enable-desktop-pwas` metadata, and ensure our custom SVG/PNG appears across install prompts, dock tile, and tab title.

## Outstanding / In Progress

- Audio analysis tee (AudioWorklet + VAD, adaptive snipping) and DSP metrics are still placeholders.
- Upload worker with retry/backoff, storage-pressure handling, and UI surfacing remains unimplemented.
- Groq/Whisper transcription batching, retry flows, and live-stream integration are stubbed; settings values are stored but unused.
- Storage-cap enforcement and automated eviction policy are not yet wired.
- Automated / simulated audio tests remain to be designed, along with required fixture guidance.
- Developer playback QA: resolve per-chunk `NotSupportedError`, expose per-chunk controls + downloads, explain init-segment artifact, and add volume slider.
- Recorder lifecycle: guarantee the final chunk persist handshake before stopping tracks.
- Branding polish: ensure macOS dock/tab/manifest metadata shows the Web Whisper name/icon everywhere.

## Next Actions

1. Stand up the AudioWorklet pipeline feeding adaptive snip heuristics and enrich manifest records with analysis signals.
2. Implement uploader + retry semantics, surface state in both primary UI and developer overlay, and respect storage caps.
3. Close the playback QA loop: fix per-chunk playback errors, add chunk downloads + tooling, expose volume slider, and document/init bootstrap slices.
4. Guarantee recorder shutdown waits for the final chunk persist; add guard rails + unit coverage for the stop handshake.
5. Verify macOS/desktop install metadata (titles, icons) and update manifest + assets as needed.
6. Wire Groq transcription worker using stored API key, stream results into live transcription panel, and enable manual retry control.
7. Design test strategy (unit + long-run scenarios) and document required audio fixtures for repeatable validation.
